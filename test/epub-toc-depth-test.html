<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPUBç›®å½•æ·±åº¦æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .chapter-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #eee;
            padding: 10px;
            margin-top: 10px;
        }
        .chapter-item {
            padding: 5px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .depth-indicator {
            display: inline-block;
            background: #007bff;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-right: 10px;
        }
        .error {
            color: #dc3545;
            background: #f8d7da;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            color: #155724;
            background: #d4edda;
            padding: 10px;
            border-radius: 4px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .loading {
            color: #007bff;
        }
    </style>
</head>
<body>
    <h1>EPUBç›®å½•æ·±åº¦è¿‡æ»¤æµ‹è¯•</h1>
    
    <div class="test-section">
        <h3>æµ‹è¯•æ–‡ä»¶é€‰æ‹©</h3>
        <input type="file" id="fileInput" accept=".epub" />
        <button id="testButton" disabled>å¼€å§‹æµ‹è¯•</button>
    </div>

    <div id="results"></div>

    <script type="module">
        // ç”±äºæ— æ³•ç›´æ¥å¯¼å…¥TypeScriptæ–‡ä»¶ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œé‡å†™å…³é”®é€»è¾‘
        console.log('ğŸ§ª EPUBç›®å½•æ·±åº¦æµ‹è¯•é¡µé¢å·²åŠ è½½');

        const fileInput = document.getElementById('fileInput');
        const testButton = document.getElementById('testButton');
        const resultsDiv = document.getElementById('results');

        let selectedFile = null;

        fileInput.addEventListener('change', (e) => {
            selectedFile = e.target.files[0];
            testButton.disabled = !selectedFile;
            if (selectedFile) {
                console.log('ğŸ“– é€‰æ‹©æ–‡ä»¶:', selectedFile.name);
            }
        });

        testButton.addEventListener('click', async () => {
            if (!selectedFile) return;
            
            console.log('ğŸš€ å¼€å§‹æµ‹è¯•EPUBç›®å½•æ·±åº¦è¿‡æ»¤');
            resultsDiv.innerHTML = '<div class="loading">æ­£åœ¨æµ‹è¯•ä¸­ï¼Œè¯·ç¨å€™...</div>';
            
            try {
                // è¿™é‡Œæˆ‘ä»¬éœ€è¦æ¨¡æ‹ŸepubProcessorçš„åŠŸèƒ½
                // ç”±äºæ— æ³•ç›´æ¥å¯¼å…¥ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç®€åŒ–ç‰ˆæœ¬æ¥æµ‹è¯•æ¦‚å¿µ
                await testEpubTocDepth(selectedFile);
            } catch (error) {
                console.error('âŒ æµ‹è¯•å¤±è´¥:', error);
                resultsDiv.innerHTML = `<div class="error">æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
            }
        });

        async function testEpubTocDepth(file) {
            // ç”±äºæ— æ³•ç›´æ¥ä½¿ç”¨epubProcessorï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ¨¡æ‹Ÿæµ‹è¯•
            // æ¥éªŒè¯ç›®å½•æ·±åº¦è¿‡æ»¤çš„æ¦‚å¿µ
            
            const testResults = [];
            const testDepths = [1, 2, 3];

            // æ¨¡æ‹Ÿçš„ç›®å½•ç»“æ„æ•°æ®ï¼ˆåŸºäºå¸¸è§EPUBç»“æ„ï¼‰
            const mockTocData = [
                { title: 'å°é¢', depth: 0 },
                { title: 'å‰è¨€', depth: 0 },
                { title: 'ç›®å½•', depth: 0 },
                { title: 'ç¬¬ä¸€ç«  æµ·é¾Ÿäº¤æ˜“æ³•åˆ™æ¦‚è¿°', depth: 0 },
                { title: '1.1 äº¤æ˜“å“²å­¦', depth: 1 },
                { title: '1.2 å†å²èƒŒæ™¯', depth: 1 },
                { title: '1.2.1 ç†æŸ¥å¾·Â·ä¸¹å°¼æ–¯', depth: 2 },
                { title: '1.2.2 å¨å»‰Â·åŸƒå…‹å“ˆç‰¹', depth: 2 },
                { title: '1.3 åŸºæœ¬åŸç†', depth: 1 },
                { title: 'ç¬¬äºŒç«  å¸‚åœºæœ¬è´¨', depth: 0 },
                { title: '2.1 è¶‹åŠ¿äº¤æ˜“', depth: 1 },
                { title: '2.2 é£é™©æ§åˆ¶', depth: 1 },
                { title: '2.2.1 ä»“ä½ç®¡ç†', depth: 2 },
                { title: '2.2.2 æ­¢æŸç­–ç•¥', depth: 2 },
                { title: 'ç¬¬ä¸‰ç«  å…·ä½“è§„åˆ™', depth: 0 },
                { title: '3.1 å…¥åœºæ¡ä»¶', depth: 1 },
                { title: '3.2 å‡ºåœºæ¡ä»¶', depth: 1 },
                { title: 'é™„å½•', depth: 0 }
            ];

            for (const depth of testDepths) {
                console.log(`ğŸ” æµ‹è¯•ç›®å½•æ·±åº¦: ${depth}`);
                
                // æ¨¡æ‹Ÿæ·±åº¦è¿‡æ»¤é€»è¾‘
                const filteredChapters = mockTocData.filter(chapter => chapter.depth < depth);
                
                const result = {
                    depth,
                    totalChapters: mockTocData.length,
                    filteredChapters: filteredChapters.length,
                    chapters: filteredChapters,
                    invalidChapters: mockTocData.filter(chapter => chapter.depth >= depth)
                };
                
                testResults.push(result);
            }

            // æ˜¾ç¤ºæµ‹è¯•ç»“æœ
            displayTestResults(testResults);
        }

        function displayTestResults(results) {
            let html = '<h2>æµ‹è¯•ç»“æœ</h2>';
            
            results.forEach(result => {
                const hasErrors = result.invalidChapters.length > 0;
                const statusClass = hasErrors ? 'error' : 'success';
                
                html += `
                    <div class="test-section">
                        <h4>æ·±åº¦è®¾ç½®: ${result.depth}</h4>
                        <p class="${statusClass}">
                            ${hasErrors 
                                ? `âŒ å‘ç°é—®é¢˜: åº”è¯¥åªæ˜¾ç¤ºæ·±åº¦${result.depth}ä»¥ä¸‹çš„ç« èŠ‚ï¼Œä½†å®é™…åŒ…å«äº†${result.invalidChapters.length}ä¸ªæ›´æ·±å±‚æ¬¡çš„ç« èŠ‚` 
                                : `âœ… è¿‡æ»¤æ­£ç¡®: æ‰€æœ‰${result.filteredChapters.length}ä¸ªç« èŠ‚éƒ½åœ¨æ·±åº¦${result.depth}èŒƒå›´å†…`}
                        </p>
                        <p>æ€»ç« èŠ‚: ${result.totalChapters}, è¿‡æ»¤å: ${result.filteredChapters.length}</p>
                        
                        <div class="chapter-list">
                            <h5>è¿‡æ»¤åçš„ç« èŠ‚:</h5>
                            ${result.chapters.map(ch => `
                                <div class="chapter-item">
                                    <span class="depth-indicator">æ·±åº¦${ch.depth}</span>
                                    ${ch.title}
                                </div>
                            `).join('')}
                        </div>
                        
                        ${hasErrors ? `
                            <div class="chapter-list" style="background: #fff3cd;">
                                <h5>âŒ é”™è¯¯åŒ…å«çš„ç« èŠ‚ (åº”è¯¥è¢«è¿‡æ»¤æ‰):</h5>
                                ${result.invalidChapters.map(ch => `
                                    <div class="chapter-item">
                                        <span class="depth-indicator" style="background: #dc3545;">æ·±åº¦${ch.depth}</span>
                                        ${ch.title}
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            html += `
                <div class="test-section">
                    <h3>ç»“è®º</h3>
                    <p><strong>å¦‚æœä¸Šè¿°æµ‹è¯•æ˜¾ç¤ºé”™è¯¯ï¼Œè¯´æ˜EPUBç›®å½•æ·±åº¦è¿‡æ»¤åŠŸèƒ½å­˜åœ¨bugã€‚</strong></p>
                    <p>æ­£ç¡®çš„å®ç°åº”è¯¥ï¼š</p>
                    <ul>
                        <li>å½“è®¾ç½®æ·±åº¦ä¸º1æ—¶ï¼Œåªæ˜¾ç¤ºæ·±åº¦0çš„ç« èŠ‚</li>
                        <li>å½“è®¾ç½®æ·±åº¦ä¸º2æ—¶ï¼Œæ˜¾ç¤ºæ·±åº¦0å’Œ1çš„ç« èŠ‚</li>
                        <li>å½“è®¾ç½®æ·±åº¦ä¸º3æ—¶ï¼Œæ˜¾ç¤ºæ·±åº¦0ã€1å’Œ2çš„ç« èŠ‚</li>
                    </ul>
                </div>
            `;
            
            resultsDiv.innerHTML = html;
        }
    </script>
</body>
</html>
