# WebDAV文件系统接入功能 TODO

## 需求目标

实现WebDAV文件系统的接入，以坚果云为典型代表，提供以下核心功能：

1. **WebDAV连接功能**：
   - 支持配置WebDAV服务器连接（服务器地址、端口、用户名、密码）
   - 提供连接性测试功能，验证配置是否正确
   - 支持保存多个WebDAV配置，便于切换不同账户

2. **文件导入功能**：
   - 从配置好的WebDAV服务器浏览和选择epub、pdf等支持的文件格式
   - 提供与本地文件导入相同的用户体验
   - 支持文件预览和基本信息显示

3. **自动同步功能**：
   - 将主程序处理完成的md文件、思维导图文件自动同步到WebDAV
   - 在WebDAV根目录下的fastReader文件夹中存储文件
   - 可在设置中开启/关闭自动同步功能
   - 支持增量同步，避免重复上传

4. **缓存管理**：
   - 使用根目录下的tmp文件夹作为本地文件缓存
   - 及时清理不需要的缓存文件
   - 提供缓存空间管理功能

**效果边界**：
- 仅支持WebDAV协议，不支持其他云存储协议
- 文件上传大小限制遵循WebDAV服务器限制（坚果云默认500M）
- 访问频率遵循WebDAV服务器限制（坚果云免费版每30分钟600次请求）
- 仅支持主程序已有的文件格式（epub、pdf等）

## 可选实现方案

### 方案一：使用webdav-client库（推荐）

**原理**：
- 使用成熟的`webdav` npm包（perry-mitchell/webdav-client）
- 该库专为浏览器和Node.js设计，支持TypeScript
- 提供完整的WebDAV操作API：文件浏览、上传、下载、目录操作等

**成本**：
- 依赖项：需要安装`webdav`包
- 代码更改：需要在现有文件系统模块中集成WebDAV客户端
- 新增组件：WebDAV配置界面、文件浏览器、同步设置

**方法优缺点**：
- 优点：库成熟稳定、API完整、支持TypeScript、文档详细、社区活跃
- 缺点：增加外部依赖、包体积约200KB

**参考来源**：
- 官方GitHub：https://github.com/perry-mitchell/webdav-client
- npm包：https://www.npmjs.com/package/webdav

### 方案二：原生fetch实现WebDAV协议

**原理**：
- 直接使用fetch API实现WebDAV协议（PROPFIND、GET、PUT等）
- 手动处理WebDAV XML响应和请求
- 自行实现认证、文件操作等功能

**成本**：
- 无额外依赖项
- 需要大量代码实现WebDAV协议细节
- 需要处理XML解析、HTTP认证等复杂逻辑

**方法优缺点**：
- 优点：无外部依赖、包体积小、完全可控
- 缺点：开发复杂度高、容易出错、需要处理各种边界情况、维护成本高

**参考来源**：
- WebDAV RFC 4918：https://tools.ietf.org/html/rfc4918
- 坚果云WebDAV配置文档

### 方案三：使用其他WebDAV库

**原理**：
- 使用其他WebDAV JavaScript库如`js-webdav-client`
- 功能与方案一类似，但使用不同的库

**成本**：
- 需要评估不同库的兼容性和功能完整性
- 可能需要额外的适配工作

**方法优缺点**：
- 优点：可能有更轻量的选择
- 缺点：库的成熟度和文档可能不如方案一、社区支持较小

**参考来源**：
- https://github.com/sara-nl/js-webdav-client
- https://github.com/dom111/webdav-js

## 执行前准备

- 确保执行前项目已经git commit，方便后期revert回滚操作
- 确保存在test目录，在test目录下隔离地试验新feature的实现方案，最可能少地破坏test结构外的原代码

## 执行阶段

按照从**简单到复杂**的顺序，依次选择每个**完整方案**，进行以下新feature的测试操作：
- 再次详细分析本方案的实现思路和具体步骤、技术细节
- 列出TODO列表，便于后期依次执行
- TODO列表后附需要注意的细节
- 按照TODO列表，依次执行
- 遵循**简单至上**原则：
  - 如果在某方案执行或者测试过程出现错误，优先在当前方案的基础上进行修改；
  - 实在发现本方案无法实现，需要放弃本方案，选择下一个方案时，才顺序测试下一个方案。
  - 也即简单方案能跑通则不用复杂方案（前提是方案已经被从简单到容易排序过）。

当选中可行方案后，评价方案实现是否和需求目标一致。
- 如果一致，则开始把功能上线到主程序。

## 补充原则

- **隔离测试**：新feature的测试过程中，尽可能在test文件夹中进行，如果万一对test文件夹以外代码有破坏，请在TODO列表中记录大致修改文件和修改思路，方便后期如果方案彻底失败，可以参照修改思路逆向回滚。
- **原子化测试**：新feature的测试过程中，尽可能将测试内容原子化，即每次只测试一个功能，而不是多个功能一起测试（测试过程也在test文件夹中进行）。
- **简单至上**：先彻底尝试简单方案，实在不能完成再尝试复杂方案。
- **立项审批**：当**可选实现方案**定型后、**执行前准备**完成前，请完成"在根目录下生成一个TODO.md文件"操作后，暂停一下，询问我"是否赞同"新的TODO.md文件内容（也即项目方案），当获得赞同（立项完成）后，再继续执行。

## 当前TODO列表（使用方案一：webdav-client库）

### 第一阶段：环境准备和基础测试
- [] 创建test目录（如果不存在）
- [] 安装webdav依赖包到测试环境
- [] 创建WebDAV连接测试脚本
- [] 使用坚果云测试账号验证连接功能
- [] 测试基本的文件操作（浏览、上传、下载）

### 第二阶段：核心功能实现
- [] 设计WebDAV配置数据结构和存储方案
- [] 实现WebDAV客户端封装类
- [] 创建WebDAV配置界面组件
- [] 实现WebDAV文件浏览器组件
- [] 集成WebDAV文件导入功能到主程序

### 第三阶段：同步功能实现
- [] 实现文件自动同步机制
- [] 创建同步设置界面
- [] 实现增量同步逻辑
- [] 添加同步状态显示和错误处理

### 第四阶段：缓存和优化
- [] 实现本地缓存管理
- [] 添加缓存清理功能
- [] 优化大文件上传下载性能
- [] 添加进度显示和取消功能

### 第五阶段：集成和测试
- [] 将WebDAV功能集成到主程序
- [] 更新设置界面添加WebDAV选项
- [] 进行完整的功能测试
- [] 编写用户文档和使用说明

### 注意事项
1. **坚果云配置信息**：
   - 服务器地址：dav.jianguoyun.com
   - 端口：443
   - 路径：/dav/
   - 认证：应用密码（非账户密码）

2. **文件存储结构**：
   - WebDAV根目录下创建fastReader文件夹
   - 按日期或项目名组织子文件夹
   - md文件和思维导图文件分别存储

3. **错误处理**：
   - 网络连接失败处理
   - 认证失败处理
   - 文件大小超限处理
   - 访问频率超限处理

4. **性能考虑**：
   - 大文件分块上传
   - 目录内容缓存
   - 懒加载文件列表
   - 并发请求控制
