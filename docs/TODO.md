# Gemini API 代理实现 TODO 列表

## 🎉 代理实现成功！

**✅ 成功方案**: `https-proxy-agent` + Node.js `https` 模块  
**📁 实现文件**: `test/http-proxy-test.cjs`  
**🔧 配置方式**: 环境变量 `HTTP_PROXY`/`HTTPS_PROXY`  
**📊 测试结果**: 代理连接成功，Gemini API 可正常使用  

### 关键发现
1. **Node.js fetch 对代理支持有限** - 需要使用专门的代理 agent
2. **https-proxy-agent 工作稳定** - 与传统 https 模块配合良好
3. **环境变量配置简单有效** - 符合 TODO 优先使用简单方案的原则

## 目标
实现对 Gemini API 的代理支持，解决网络访问限制问题 ✅ **已完成**

## 实现方案（由简单到复杂）

### 阶段一：基础环境变量配置
- [x] **方案1.1**: 测试 HTTP_PROXY 环境变量
  - [x] 在 `.env` 文件中添加 `HTTP_PROXY=http://127.0.0.1:10808`
  - [x] 在 `.env` 文件中添加 `HTTPS_PROXY=http://127.0.0.1:10808`
  - [x] 测试现有代码是否能正常使用代理
  - [x] 验证代理连接状态

- [ ] **方案1.2**: 测试 SOCKS5 代理支持
  - [ ] 配置 `HTTP_PROXY=socks5://127.0.0.1:1080`
  - [ ] 配置 `HTTPS_PROXY=socks5://127.0.0.1:1080`
  - [ ] 测试 SOCKS5 代理是否被正确识别
  - [ ] 处理可能的 SOCKS5 不兼容问题

- [x] **方案1.3**: 配置 no_proxy 排除规则 ✅ **成功方案**
  - [x] 添加 `NO_PROXY=127.0.0.1,localhost`
  - [x] 确保本地服务不走代理
  - [x] 测试混合代理场景
  - **✅ 实现方式**: 使用 `https-proxy-agent` + Node.js `https` 模块
  - **✅ 测试文件**: `test/http-proxy-test.cjs`
  - **✅ 状态**: 代理连接成功，Gemini API 可正常使用

### 阶段二：Node.js 专用代理实现
- [ ] **方案2.1**: 集成 undici EnvHttpProxyAgent
  - [ ] 安装 `undici` 依赖
  - [ ] 修改 `aiService.ts` 使用 EnvHttpProxyAgent
  - [ ] 配置自动读取环境变量
  - [ ] 测试 HTTP/HTTPS/SOCKS5 代理支持

- [ ] **方案2.2**: 实现自定义 ProxyAgent
  - [ ] 安装 `https-proxy-agent` 依赖
  - [ ] 创建代理配置管理模块
  - [ ] 实现代理连接池管理
  - [ ] 添加代理故障切换机制

- [ ] **方案2.3**: 实现 SOCKS5 专用代理
  - [ ] 安装 `socks-proxy-agent` 依赖
  - [ ] 实现 SOCKS5 代理连接
  - [ ] 处理认证代理场景
  - [ ] 测试代理性能和稳定性

### 阶段三：AI SDK 集成优化
- [ ] **方案3.1**: 自定义 fetch 实现
  - [ ] 修改 `@ai-sdk/google` 配置
  - [ ] 实现带代理的 fetch 函数
  - [ ] 集成到现有的 AI 服务中
  - [ ] 测试各种 AI 功能的代理支持

- [ ] **方案3.2**: 实现代理中间件
  - [ ] 创建代理中间件模块
  - [ ] 实现请求拦截和路由
  - [ ] 添加代理状态监控
  - [ ] 实现代理自动切换

### 阶段四：代理转换方案
- [ ] **方案4.1**: 集成 gemini-openai-proxy
  - [ ] 部署本地 gemini-openai-proxy 服务
  - [ ] 修改 API 端点指向本地代理
  - [ ] 配置 OpenAI 兼容接口
  - [ ] 测试聊天完成功能

- [ ] **方案4.2**: 实现自定义代理转换
  - [ ] 创建 Gemini 到 OpenAI 协议转换
  - [ ] 支持流式响应转换
  - [ ] 实现错误处理和重试机制
  - [ ] 优化转换性能

### 阶段五：高级代理功能
- [ ] **方案5.1**: 代理池管理
  - [ ] 实现多代理服务器支持
  - [ ] 添加代理健康检查
  - [ ] 实现负载均衡算法
  - [ ] 配置代理故障转移

- [ ] **方案5.2**: 代理认证和安全
  - [ ] 支持用户名密码认证
  - [ ] 实现代理凭据加密存储
  - [ ] 添加代理连接日志
  - [ ] 实现代理访问控制

- [ ] **方案5.3**: 代理性能优化
  - [ ] 实现代理连接复用
  - [ ] 添加请求缓存机制
  - [ ] 优化代理超时设置
  - [ ] 实现代理性能监控

## 测试计划

### 单元测试
- [ ] 代理连接测试
- [ ] 环境变量解析测试
- [ ] 代理故障切换测试
- [ ] 性能基准测试

### 集成测试
- [ ] 端到端 API 调用测试
- [ ] 多种代理类型测试
- [ ] 网络异常场景测试
- [ ] 并发请求代理测试

### 用户验收测试
- [ ] 不同网络环境测试
- [ ] 用户体验测试
- [ ] 配置易用性测试
- [ ] 错误提示友好性测试

## 配置文件规划

### 环境变量配置
```env
# 代理配置
HTTP_PROXY=http://127.0.0.1:10808
HTTPS_PROXY=http://127.0.0.1:10808
NO_PROXY=127.0.0.1,localhost

# 代理认证（可选）
PROXY_USERNAME=
PROXY_PASSWORD=
```

### 应用配置
```json
{
  "proxy": {
    "enabled": true,
    "type": "http", // http, socks5, auto
    "host": "127.0.0.1",
    "port": 8080,
    "timeout": 30000,
    "retryCount": 3
  }
}
```

## 文档需求
- [ ] 代理配置说明文档
- [ ] 故障排除指南
- [ ] 性能优化建议
- [ ] 安全最佳实践

## 里程碑目标
1. **MVP版本**：实现基础环境变量代理支持
2. **Beta版本**：完成 Node.js 专用代理实现
3. **RC版本**：集成 AI SDK 优化和代理转换
4. **正式版本**：完成高级功能和完整测试

## 风险评估
- **技术风险**：不同代理协议兼容性问题
- **性能风险**：代理可能增加请求延迟
- **安全风险**：代理服务器可能存在安全隐患
- **维护风险**：代理配置复杂度增加用户使用门槛

## 资源需求
- 开发时间：预计 2-3 周
- 测试环境：需要多种代理服务器环境
- 文档时间：预计 3-5 天
- 维护成本：中等，需要持续关注代理服务状态
